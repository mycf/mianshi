在 Kafka 集群中会有一个或多个 broker，其中有一个 broker 会被选举为控制器（Kafka Controller），它负责管理整个集群中所有分区和副本的状态。
当某个分区的leader副本出现故障时，由==控制器负责为该分区选举新的leader副本==。
当检测到某个分区的ISR集合发生变化时，由==控制器负责通知所有broker更新其元数据信息==。
当使用kafka-topics.sh脚本为某个topic增加分区数量时，同样还是由==控制器负责分区的重新分配。==

# 控制器的选举及异常恢复

Kafka中的控制器选举工作依赖于ZooKeeper，成功竞选为控制器的broker会在ZooKeeper中创建/controller这个临时（EPHEMERAL）节点，此临时节点的内容参考如下：
```json
{"version":2,"brokerid":0,"timestamp":"17034kk'kk'kk'k08057780","kraftControllerEpoch":-1}
kk'kk'k```
其中version在目前版本中固定为2，brokerid表示成为控制器的broker的id编号，timestamp表示竞选成为控制器时的时间戳kk。

在任意时刻，集群中有且仅有一个控制器。每个 broker 启动的时候会去尝试读取/controller节点的brokerid的值，如果读取到brokerid的值不为-1，则表示已经有其他 broker 节点成功竞选为控制器，所以当前 broker 就会放弃竞选；如果ZooKeeper 中不存在/controller节点，或者这个节点中的数据异常，那么就会尝试去创建/controller节点。当前broker去创建节点的时候，也有可能其他broker同时去尝试创建这个节点，只有创建成功的那个broker才会成为控制器，而创建失败的broker竞选失败。每个broker都会在内存中保存当前控制器的brokerid值，这个值可以标识为activeControllerId。


